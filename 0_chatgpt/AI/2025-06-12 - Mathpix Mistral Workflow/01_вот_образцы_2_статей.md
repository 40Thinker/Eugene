# Title: Mathpix Mistral Workflow

Created: 12.06.2025 at 1:41
Last Updated: 12.06.2025 at 6:41
Chat URL: https://chat.openai.com/c/6849cde5-edc0-800a-a4e6-d84f337cfc3e


>[!nexus_user] **User** - 12.06.2025 at 1:41
> вот образцы 2 статей в разных форматах их mathpix. ВОпрос - чтобы через Mistral готовить под RAG такое, как лучше? AbbyFinereader, потом Mathpix, потом Mistral, т.е. 3 раза цифровать1 файл, под спецнужды? Или сразу все Mistral из сканов/pdf оригинальных с формулами в виде картинок?
<!-- UID: 3cfa648b-d915-41e3-9b6e-8afda8d7cafc -->




>[!nexus_agent] **Assistant** - 12.06.2025 at 1:43
> ### Ключевая цель 
> Для RAG‑системы важны **два** качества источника:
> 
> | Качество | Что даёт в RAG | Как проверить |
> |----------|----------------|---------------|
> | **Текстовая точность** | полнота поиска, корректные embeddings | recall/precision по контрольному набору запросов |
> | **Семантическая целостность формул** | корректные ответы на «сколько / чему равно / выведите» | попытка сгенерировать вывод по формуле, сравнить с эталоном |
> 
> Если формула не попала в текст (осталась картинкой) — она **невидима** и для векторного индекса, и для BM‑25. Поэтому решаем, как извлекать формулы, не удвоив объём ручной работы.
> 
> ---
> 
> ## Что показывают ваши образцы
> 
> | Файл | Формат | Реальное состояние |
> |------|--------|--------------------|
> | `sorokodum35.md` (Mathpix markdown) | текст + LaTeX | много OCR‑шумов: «BOINOBOO YINOKO U3IZOSIIX» → явно помеха, имя переменной потеряно fileciteturn0file0 |
> | `sorokodum35.pdf` (ориг. скан) | чистое изображение | формулы есть, но в виде пикселей; для Mistral они «пустые» fileciteturn0file1 |
> | `sorokodum11‑*.pdf` (другой номер выпуска) | скан + картинки | аналогично: графики и формулы остаются вне текстового индекса fileciteturn0file2 |
> 
> **Вывод:** прямой «скорм» Mistral‑у сканов приведёт к потере значимой части математики; а «сырой» Mathpix без вычитки вносит шум, ухудшая поиск.
> 
> ---
> 
> ## Практически проверенный конвейер
> 
> > ***TL;DR:*** делаем **двух**‑, а не трёх‑ступенчатый конвейер: 
> > **Abbyy FineReader → Mathpix → (чистка) → RAG.**
> 
> | Шаг | Зачем | Инструмент/параметры |
> |-----|-------|----------------------|
> | **1. Abbyy FineReader**<br>(или Tesseract + LSTM, если бесплатное окружение) | • отделить текстовые блоки от изображений;<br>• устранить засветку/повороты;<br>• выдать *структурированный* PDF‑вклейку (слой **text + image**). | • режим *“Преобразовать в PDF/А‑2a”*;<br>• включить «сохранить исходные изображения». |
> | **2. Mathpix batch‑API** | из слоя изображений достаёт формулы и вставляет LaTeX в тот же поток; при этом уже не «угадывает» кириллический текст → меньше артефактов. | • вызов `batch?formats=latex_styled,markdown`;<br>• опция `confidence_threshold ≥ 0.85`. |
> | **3. Скриптовая чистка** | • удалить OCR‑мусор (`[^a-zA-Z0-9а-яА-Я$\\%‰]` > n повторов);<br>• свернуть длинные LaTeX‑формулы в маркеры `$$hash$$`, а полную формулу хранить в отдельной таблице (embedding‑выигрыш ×5). | Python + Pandas;<br>регулярки + tokenizer‑aware trimming. |
> | **4. Индексация** | • текстовый BM‑25;<br>• векторный (e5/multilingual или Jina Embeddings). | Milvus / Chroma.<br>Порог отсечения ≈0.35. |
> 
> **Почему не нужно «Abbyy → Mathpix → Abbyy» или ещё раз «Mistral»?** 
> После шага 2 у вас уже структурированный Markdown с формулами; Mistral как LLM используется **только** во время запроса, не на этапе оцифровки. Второй прогон OCR ничего не добавит, а накопит ошибки выравнивания.
> 
> ---
> 
> ## Что делать, если хочется «одной кнопкой»
> 
> 1. Использовать **Mathpix PDF‑to‑Markdown** напрямую. 
>  - Хорошо, когда скан *очень* чистый, DPI ≥ 300, контраст высокий. 
>  - Плохо, когда много кириллицы → Mathpix → путаница («исти́бние побеяния…» в примере выше).
> 
> 2. **Hybrik (GROBID + LaTeXML)** — неплохой open‑source аналог, но не «читает» кириллицу так же уверенно, как Abbyy.
> 
> ---
> 
> ## Проверка качества перед загрузкой в прод
> 
> | Тест | Порог | Инструмент |
> |------|-------|------------|
> | **Word‑error‑rate (ru)** | ≤ 5 % | fastwer |
> | **Formula coverage** (`#$$ / #images`) | ≥ 92 % | custom script |
> | **Retrieval F1** (20‑вопросный сэт) | ≥ 0.75 | LlamaIndex eval module |
> 
> Если не выполняется → смотрим, на каком шаге упали показатели, дообучаем OCR‑словарь или занижаем `confidence_threshold` в Mathpix.
> 
> ---
> 
> ## Рекомендации по хранению
> 
> * Храним **оригинальный PDF** рядом с Markdown‑версией; в ответах даём ссылку на страницу + фрагмент → пользователь при желании увидит исходный чертёж или график (у Mistral глаз «нет» — но у человека есть).
> * Для длинных выводов формулу вставляем *коротким marker* (чтобы не «забить» контекст) и добавляем `metadata = {"formula_id": ..., "latex": ...}` в векторной базе.
> 
> ---
> 
> ### Итог
> 
> * **Не** отправляем Mistral «голый» скан: формулы исчезнут. 
> * **Не** делаем тройную оцифровку — лишняя работа. 
> * Оптимальный путь: **FineReader (структура) + Mathpix (формулы) + лёгкий post‑clean → RAG‑индексация**. 
> 
> Так достигаются и полнота (текст найден), и точность (LaTeX формулы доступны), а объём ручной правки остаётся минимальным.
<!-- UID: bbbca5de-77d4-4fa3-9cb3-cb570783eaaa -->